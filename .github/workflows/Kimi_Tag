import re
import os
import pandas as pd
from openai import OpenAI
import time

def process_ref(ref_path):
    # Load reference file
    content = open(ref_path, encoding='utf-8').readlines()
    ref = []
    for line in content:
        ref.append(line.split(" ", 1))
    df = pd.DataFrame(ref)
    df.set_index(0, inplace=True)
    try:
       abstract = df.loc['AB'].iloc[0]#åœ¨Refwork Taggedæ–‡çŒ®æ ¼å¼é‡Œé¢ï¼šAB [æ‘˜è¦å†…å®¹]
               ===============================

                  å¯ä»¥æ ¹æ®éœ€è¦å¢åŠ æ ‡é¢˜/å…³é”®è¯ç­‰ä¿¡æ¯è¿›è¡Œåˆ¤æ–­

               ===============================
    except KeyError:
        content.append("\nK1 æ²¡æœ‰æ‘˜è¦")
        print("K1 æ²¡æœ‰æ‘˜è¦\n")
        processed_ref_path = os.path.join(Tagged_Path, os.path.basename(ref_path))
        with open(processed_ref_path, "w", encoding='utf-8') as file:
            file.writelines(content)
        answer = "========æ²¡æœ‰æ‘˜è¦ä¿¡æ¯========\n"
        return answer
       
    # Construct user input
    user_input = f"\
    Read the abstract below and answer the questions based on the abstract:\
    1. Is this article studying humans? Answer No if it is non-human such as rats, mice, monkeys, etc. Answer Yes as long as the study is on human beings/human brain (only Yes, No) \
    2ã€Is the type of this article an experimental report, a review, or a meta-analysis? (only need to answer the type of article: Research, Meta, Review, Not sure)\
    3. Other Question (Only answer Yes, No, Not sure)\
    4ã€Other Question (Only answer Yes, No, Not sure)\
    5ã€Indicate the specific information of the article that made you make the judgement in the previous four questions, please quote the original article.\
        Abstract: '{abstract}'\#ä½ å¯ä»¥è®©AIå¯¹ä¸Šé¢çš„å›ç­”è¿›è¡Œè§£é‡Šï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆæƒ³çš„ï¼Œä»¥åŠå®ƒçš„å‚è€ƒä¿¡æ¯ï¼Œæ–¹é¢åé¢è¿›è¡Œæ ¡å¯¹
    \
    The answer template is: \#ç»™å‡ºä¸€ä¸ªç­”é¢˜æ¨¡æ¿
    Answer:\n\
    1. No\n\
    2. Research\n\
    3. Yes\n\
    4. Not sure\n\
    \
    åˆ¤æ–­ä¾æ®ï¼š\n\
    é—®é¢˜1ï¼Œæ–‡ç« ä¸­æåˆ°äº†ç ”ç©¶å¯¹è±¡æ˜¯â€œ20 right-handed healthy femalesâ€ï¼Œè¿™è¡¨æ˜ç ”ç©¶çš„æ˜¯æˆå¹´äººï¼Œå› æ­¤å›ç­”Yesã€‚\n\
    é—®é¢˜2ï¼Œæ–‡ç« ä¸­æåˆ°äº†â€œsham-controlled, single-blind crossover study using fMRIâ€ï¼Œè¿™è¡¨æ˜è¿›è¡Œäº†ä¸€é¡¹æœ‰å¯¹ç…§ã€æœ‰ç›²æ³•çš„å®éªŒç ”ç©¶ï¼Œå› æ­¤æ–‡ç« ç±»å‹ä¸ºResearchã€‚\n\
    é—®é¢˜3ï¼Œ\n\
    é—®é¢˜4ï¼Œ\n\
    \n\n\
    æ³¨!!!!! å¦‚æœæœªæä¾›æ‘˜è¦æˆ–æ‘˜è¦ä¸å®Œæ•´ï¼Œè¯·å›ç­”: **No Abstract** \n"#è¿™é‡Œæœ‰çš„æ—¶å€™AIå¯èƒ½ä¸ä¸€å®šçœ‹åˆ°ï¼ˆğŸ˜“ï¼‰
    
    # Send request
    client = OpenAI(
        api_key=Your_API_KEY,
        base_url="https://api.moonshot.cn/v1",# Kimiçš„APIç½‘å€
    )

    # å‡†å¤‡å¯¹è¯å†å²å’Œç”¨æˆ·è¾“å…¥
    history = [
        {"role": "system", "content": "æ‚¨æ˜¯ Moonshot AI æä¾›çš„äººå·¥æ™ºèƒ½åŠ©æ‰‹ã€‚"},
    ]
    messages = history + [{"role": "user", "content": user_input}]
    completion = client.chat.completions.create(
        model="moonshot-v1-8k",
        messages=messages,
        temperature=0.3,#æ•°å€¼è¶Šå°ï¼Œæ¨¡å‹ç”Ÿæˆçš„æ–‡æœ¬è¶Šä¿å®ˆï¼Œæ›´åŠ å€¾å‘äºé€‰æ‹©æœ€å¯èƒ½çš„è¯è¯­æˆ–çŸ­è¯­
    )
    answer = completion.choices[0].message.content
    # Process answer
    include_tag = 0
    if answer.find("**No Abstract**") != -1:
        answer = "========æ²¡æœ‰æ‘˜è¦ä¿¡æ¯========\n"
        print(f"======================= Answer ===========================\n {answer}\n")
        content.append("\nK1 æ²¡æœ‰æ‘˜è¦")
               ===============================

                  åœ¨Refwork Taggedæ–‡çŒ®æ ¼å¼é‡Œé¢ï¼šK1 [æ ‡ç­¾å†…å®¹]
                                               NO <p>[ç¬”è®°å†…å®¹]</p>ï¼ˆ&nbsp;ä»£è¡¨ç©ºæ ¼ï¼‰

               ===============================
        print("\nK1 æ²¡æœ‰æ‘˜è¦\n")
        include_tag = 1# 
        return answer
    else:
        print(f"======================= Answer ===========================\n {answer}\n")
        qa = re.findall(r'\d+\.\s*(.*)', answer)
        try:
            if qa[0] == 'No':
                content.append("\nK1 é¦–ç­›æ’é™¤-Not human")
                print("\nK1 é¦–ç­›æ’é™¤-Not human\n")
                include_tag = 1
            else:
                if qa[1] != 'Research':
                    content.append(f"\nK1 é¦–ç­›æ’é™¤-{qa[1]}")
                    print(f"\nK1 é¦–ç­›æ’é™¤-{qa[1]}\n")
                    include_tag = 1
               ===============================

                  è¿™é‡Œéƒ½æ˜¯ä½ çš„Tagåˆ¤å®šå’ŒTagè®¾ç½®

               ===============================
        except:
            answer = "========æ²¡æœ‰æ‘˜è¦ä¿¡æ¯========\n"
            print(f"======================= Answer ===========================\n {answer}\n")
            content.append("\nK1 æ²¡æœ‰æ‘˜è¦")
            print("\nK1 æ²¡æœ‰æ‘˜è¦\n")
            include_tag = 1
            return answer
    if include_tag==0:
        content.append("\nK1 é¦–ç­›çº³å…¥")
        print("\nK1 é¦–ç­›çº³å…¥\n")
    Note = answer.replace(" ","&nbsp;")
    content.append(f"\nNO <p>{Note}</p>")
    # Write back to file

    processed_ref_path = os.path.join(r"S:\ä¾ç‘å¾·\å„¿ç«¥MEPå…ƒåˆ†æ\Case report_processed", os.path.basename(ref_path))
    with open(processed_ref_path, "w", encoding='utf-8') as file:
        file.writelines(content)
    return answer


ref_list = os.listdir(r"S:\ä¾ç‘å¾·\å„¿ç«¥MEPå…ƒåˆ†æ\Case report")
total_refs = len(ref_list)
start_index = int(input("Enter the start index: ")) # Specify the index to start processing from
ref_list = ref_list[start_index:]
total_refs -= start_index
current_ref_index = 0+start_index

for ref_name in ref_list:
    ref_path = os.path.join(r"S:\ä¾ç‘å¾·\å„¿ç«¥MEPå…ƒåˆ†æ\Case report", ref_name)
    print(f"======================= {ref_name} ===========================\n")
    answer = process_ref(ref_path)
    current_ref_index += 1
    print(f"======================= å¤„ç†è¿›åº¦ï¼šNo.{current_ref_index} {current_ref_index-start_index}/{total_refs} ===========================\n")
    time.sleep(5)  # Wait for 5 seconds before processing the next ref
    with open(r"S:\ä¾ç‘å¾·\å„¿ç«¥MEPå…ƒåˆ†æ\Result_Case report.txt",'a', encoding='utf-8') as file:
        file.writelines(f"{ref_name}\n")
        file.writelines(answer)
        file.writelines("\n\n")
print("============= Congratulation! Finish! =================")
